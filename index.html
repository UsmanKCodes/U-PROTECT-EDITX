<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>U-PROTECT REDACT | Elite Control</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root { 
      --neon: #00d2ff; 
      --neon-glow: 0 0 15px rgba(0, 210, 255, 0.7);
      --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%);
      --nav-white: #ffffff; 
    }
    
    body { 
      margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; 
      background: var(--bg-gradient); 
      background-attachment: fixed;
      color: #f8fafc; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
    }

    header { 
      padding: 12px 30px; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(15px);
      border-bottom: 1px solid rgba(0, 210, 255, 0.3); display: flex; justify-content: space-between; align-items: center;
      box-shadow: var(--neon-glow); z-index: 100;
    }

    .brand { font-weight: 800; font-size: 20px; letter-spacing: 1px; text-shadow: var(--neon-glow); }
    .brand span { color: var(--neon); }

    .navbar {
      background: var(--nav-white); padding: 10px 25px; display: flex; align-items: center; gap: 20px;
      box-shadow: 0 5px 25px rgba(0,0,0,0.4); color: #334155; z-index: 90;
    }

    .nav-group { display: flex; align-items: center; gap: 10px; padding-right: 15px; border-right: 1px solid #e2e8f0; }
    .section-tag { font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; }

    .btn-action {
      border: 1px solid #e2e8f0; background: #f8fafc; color: #475569; padding: 8px 14px;
      border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 13px; display: flex; align-items: center; gap: 6px;
      transition: 0.3s;
    }
    .btn-action:hover { border-color: var(--neon); color: #0f172a; box-shadow: 0 0 10px rgba(0, 210, 255, 0.2); }
    .btn-action.active { background: #0f172a; color: var(--neon); border-color: var(--neon); box-shadow: var(--neon-glow); }

    .swatch { width: 22px; height: 22px; border-radius: 50%; cursor: pointer; border: 2px solid #fff; box-shadow: 0 0 4px rgba(0,0,0,0.2); }
    .swatch.active { transform: scale(1.2); border-color: var(--neon); box-shadow: var(--neon-glow); }

    /* FIXED VIEWPORT FOR PROPER IMAGE DISPLAY */
    .viewport { 
      flex: 1; 
      overflow: auto; 
      display: flex; 
      justify-content: center; 
      align-items: flex-start; /* Image ko top se start karega */
      padding: 60px 20px; 
      position: relative; 
    }

    #transform-layer { 
      transform-origin: top center; 
      transition: transform 0.2s ease; 
      display: none; 
      margin-bottom: 100px;
    }

    .canvas-card { position: relative; background: white; box-shadow: 0 40px 80px rgba(0,0,0,0.6); border-radius: 4px; }
    #redact-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
    .box { position: absolute; pointer-events: auto; cursor: crosshair; }
    .box.selected { outline: 3px solid var(--neon); outline-offset: 4px; box-shadow: var(--neon-glow); z-index: 10; }

    .control-hub {
      position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%);
      background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); padding: 12px 30px; border-radius: 50px;
      display: flex; gap: 20px; align-items: center; border: 1px solid var(--neon); box-shadow: var(--neon-glow); z-index: 1000;
    }
    .hub-btn { background: none; border: none; color: white; cursor: pointer; font-size: 16px; transition: 0.2s; }
    .hub-btn:hover { color: var(--neon); transform: scale(1.2); }

    .btn-download { 
        background: var(--neon); color: #000; border: none; padding: 10px 22px; border-radius: 8px; 
        font-weight: 800; cursor: pointer; transition: 0.3s; box-shadow: var(--neon-glow);
    }

    footer {
        background: rgba(15, 23, 42, 0.95); padding: 12px; text-align: center;
        border-top: 1px solid rgba(0, 210, 255, 0.2); font-size: 13px; letter-spacing: 1px;
        position: relative; z-index: 100;
    }
    .footer-name { color: var(--neon); font-weight: 800; text-transform: uppercase; text-shadow: var(--neon-glow); }

    #fileIn { display: none; }
  </style>
</head>
<body>

<header>
  <div class="brand">U-PROTECT <span><B>EDITX</B></span></div>
  <div style="display:flex; align-items:center; gap:20px">
    <span id="batch-loader" style="display:none; color:var(--neon); font-size:12px; font-weight:bold"><i class="fas fa-spinner fa-spin"></i> GENERATING...</span>
    <button class="btn-download" onclick="handleExport()"><i class="fa-solid fa-cloud-arrow-down"></i> SAVE PROTECTED FILE</button>
  </div>
</header>

<div class="navbar">
  <div class="nav-group">
    <span class="section-tag">File</span>
    <button class="btn-action" onclick="location.reload()"><i class="fa-solid fa-folder-open"></i> Close & New</button>
  </div>
  <div class="nav-group">
    <span class="section-tag">Tools</span>
    <button class="btn-action active" id="btn-draw" onclick="changeMode('draw')"><i class="fa-solid fa-highlighter"></i> Redact</button>
    <button class="btn-action" id="btn-select" onclick="changeMode('select')"><i class="fa-solid fa-arrow-pointer"></i> Select</button>
  </div>
  <div class="nav-group">
    <span class="section-tag">View</span>
    <button class="btn-action" onclick="rotate360()"><i class="fa-solid fa-rotate"></i> Rotate</button>
  </div>
  <div class="nav-group">
    <span class="section-tag">Color</span>
    <div style="display:flex; gap:8px">
      <div class="swatch active" data-color="#000000" style="background:#000"></div>
      <div class="swatch" data-color="#ffffff" style="background:#fff; border:1px solid #ddd"></div>
      <div class="swatch" data-color="#ef4444" style="background:#ef4444"></div>
      <input type="color" id="hex-color" style="width:22px; height:22px; border:none; background:none; cursor:pointer">
    </div>
  </div>
  <button class="btn-action" onclick="removeBox()" style="color:#dc2626; margin-left:auto; border-color:#fecaca"><i class="fa-solid fa-trash"></i> Delete</button>
</div>

<div class="viewport">
  <div id="welcome-screen" style="text-align:center; margin-top:100px">
    <div style="font-size:80px; color:var(--neon); margin-bottom:20px; filter: drop-shadow(var(--neon-glow))"><i class="fa-solid fa-shield-halved"></i></div>
    <h1 style="margin:0; font-size: 3rem; letter-spacing: 2px;">U-PROTECT <span style="color:var(--neon)">ELITE</span></h1>
    <p style="color:#94a3b8; font-size: 1.1rem;">Secure Redaction System</p>
    <button class="btn-download" style="padding:15px 40px; margin-top:20px" onclick="document.getElementById('fileIn').click()">SELECT DOCUMENT</button>
  </div>
  <div id="transform-layer">
    <div class="canvas-card" id="canvas-container">
      <canvas id="mainCanvas"></canvas>
      <div id="redact-overlay"></div>
    </div>
  </div>
</div>

<div class="control-hub" id="control-bar" style="display:none">
  <div style="display:flex; gap:10px; align-items:center">
    <button class="hub-btn" onclick="goToPage(-1)"><i class="fa-solid fa-chevron-left"></i></button>
    <span id="page-display" style="font-weight:bold; color:var(--neon); min-width:60px; text-align:center">1 / 1</span>
    <button class="hub-btn" onclick="goToPage(1)"><i class="fa-solid fa-chevron-right"></i></button>
  </div>
  <div style="width:1px; height:25px; background:rgba(255,255,255,0.1)"></div>
  <div style="display:flex; gap:10px; align-items:center">
    <button class="hub-btn" onclick="setZoom(-0.1)"><i class="fa-solid fa-minus-circle"></i></button>
    <span id="zoom-label" style="font-size:12px; font-weight:800; min-width:40px">100%</span>
    <button class="hub-btn" onclick="setZoom(0.1)"><i class="fa-solid fa-plus-circle"></i></button>
  </div>
</div>

<footer>
    <div class="footer-text">CREATED BY <span class="footer-name">Usman Faisal</span></div>
</footer>

<input type="file" id="fileIn" accept="application/pdf,image/*">

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  const { jsPDF } = window.jspdf;

  const canvas = document.getElementById('mainCanvas'), ctx = canvas.getContext('2d');
  const container = document.getElementById('canvas-container'), overlay = document.getElementById('redact-overlay');
  const transformLayer = document.getElementById('transform-layer');
  const fileInput = document.getElementById('fileIn');
  
  let doc = null, curP = 1, isDrawing = false, rotation = 0, zoom = 1.0;
  let activeMode = 'draw', startX, startY, tempBox, selectedBox = null, activeColor = "#000000", storage = {}, fName = "", isPDF = false;

  fileInput.onchange = async (e) => {
    const file = e.target.files[0]; if(!file) return;
    fName = file.name;
    isPDF = file.type === "application/pdf";
    document.getElementById('welcome-screen').style.display = 'none';
    transformLayer.style.display = 'block';
    document.getElementById('control-bar').style.display = 'flex';

    if(isPDF) {
      const buffer = await file.arrayBuffer();
      doc = await pdfjsLib.getDocument({ data: buffer }).promise;
      render(1);
    } else {
      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = new Image();
        img.onload = () => { 
          canvas.width = img.width; 
          canvas.height = img.height; 
          ctx.drawImage(img, 0, 0); 
          
          // Auto-zoom to fit screen width
          const vWidth = document.querySelector('.viewport').clientWidth - 100;
          zoom = Math.min(1, vWidth / img.width);
          
          updateView();
          syncLayout(); 
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    }
  };

  async function render(n) {
    const page = await doc.getPage(n);
    const vp = page.getViewport({ scale: 2.0 });
    canvas.width = vp.width; canvas.height = vp.height;
    await page.render({ canvasContext: ctx, viewport: vp }).promise;
    curP = n; document.getElementById('page-display').innerText = `${n} / ${doc.numPages}`;
    syncLayout(); loadBoxes();
  }

  function handleExport() {
    if (isPDF) exportFullPDF();
    else exportImage();
  }

  function exportImage() {
    saveBoxes();
    const tCanvas = document.createElement('canvas');
    const tCtx = tCanvas.getContext('2d');
    tCanvas.width = canvas.width; tCanvas.height = canvas.height;
    tCtx.drawImage(canvas, 0, 0);
    (storage[1] || []).forEach(b => {
      tCtx.fillStyle = b.c;
      tCtx.fillRect(parseFloat(b.l), parseFloat(b.t), parseFloat(b.w), parseFloat(b.h));
    });
    const link = document.createElement('a');
    link.download = fName.split('.')[0] + "_REDACTED.jpg";
    link.href = tCanvas.toDataURL('image/jpeg', 0.95);
    link.click();
  }

  async function exportFullPDF() {
    saveBoxes();
    document.getElementById('batch-loader').style.display = 'inline';
    const total = doc.numPages;
    const tCanvas = document.createElement('canvas');
    const tCtx = tCanvas.getContext('2d');
    let finalDoc = null;

    for (let i = 1; i <= total; i++) {
      const pg = await doc.getPage(i);
      const vp = pg.getViewport({ scale: 2.0 });
      tCanvas.width = vp.width; tCanvas.height = vp.height;
      await pg.render({ canvasContext: tCtx, viewport: vp }).promise;
      (storage[i] || []).forEach(b => {
        tCtx.fillStyle = b.c;
        tCtx.fillRect(parseFloat(b.l), parseFloat(b.t), parseFloat(b.w), parseFloat(b.h));
      });
      const img = tCanvas.toDataURL('image/jpeg', 0.95);
      if (i === 1) finalDoc = new jsPDF({ orientation: vp.width > vp.height ? 'l' : 'p', unit: 'px', format: [vp.width, vp.height] });
      else finalDoc.addPage([vp.width, vp.height], vp.width > vp.height ? 'l' : 'p');
      finalDoc.addImage(img, 'JPEG', 0, 0, vp.width, vp.height);
    }
    finalDoc.save(fName.split('.')[0] + "_REDACTED.pdf");
    document.getElementById('batch-loader').style.display = 'none';
  }

  function syncLayout() { container.style.width = canvas.width+'px'; container.style.height = canvas.height+'px'; }
  function changeMode(m) { activeMode = m; document.getElementById('btn-draw').classList.toggle('active', m==='draw'); document.getElementById('btn-select').classList.toggle('active', m==='select'); deselect(); }
  function rotate360() { rotation = (rotation + 90) % 360; updateView(); }
  function setZoom(v) { zoom = Math.max(0.05, zoom + v); updateView(); }
  function updateView() { transformLayer.style.transform = `scale(${zoom}) rotate(${rotation}deg)`; document.getElementById('zoom-label').innerText = Math.round(zoom*100)+'%'; }

  container.onmousedown = (e) => {
    if(activeMode !== 'draw') return;
    isDrawing = true; const r = container.getBoundingClientRect();
    const rad = rotation * Math.PI / 180;
    const dx = (e.clientX - r.left - r.width/2) / zoom;
    const dy = (e.clientY - r.top - r.height/2) / zoom;
    startX = (dx * Math.cos(rad) + dy * Math.sin(rad)) + canvas.width/2;
    startY = (dy * Math.cos(rad) - dx * Math.sin(rad)) + canvas.height/2;
    tempBox = document.createElement('div');
    tempBox.className = 'box'; tempBox.style.background = activeColor;
    tempBox.style.left = startX + 'px'; tempBox.style.top = startY + 'px';
    overlay.appendChild(tempBox);
  };

  window.onmousemove = (e) => {
    if(!isDrawing) return;
    const r = container.getBoundingClientRect();
    const rad = rotation * Math.PI / 180;
    const dx = (e.clientX - r.left - r.width/2) / zoom;
    const dy = (e.clientY - r.top - r.height/2) / zoom;
    const cx = (dx * Math.cos(rad) + dy * Math.sin(rad)) + canvas.width/2;
    const cy = (dy * Math.cos(rad) - dx * Math.sin(rad)) + canvas.height/2;
    tempBox.style.width = Math.abs(cx - startX) + 'px';
    tempBox.style.height = Math.abs(cy - startY) + 'px';
    tempBox.style.left = Math.min(cx, startX) + 'px';
    tempBox.style.top = Math.min(cy, startY) + 'px';
  };

  window.onmouseup = () => { if(isDrawing) { isDrawing = false; bindBox(tempBox); saveBoxes(); } };
  function bindBox(el) { el.onclick = (e) => { if(activeMode === 'select') { e.stopPropagation(); deselect(); el.classList.add('selected'); selectedBox = el; } }; }
  function deselect() { document.querySelectorAll('.box').forEach(b => b.classList.remove('selected')); selectedBox = null; }
  function removeBox() { if(selectedBox) { selectedBox.remove(); selectedBox = null; saveBoxes(); } }
  function saveBoxes() {
    const data = [];
    overlay.querySelectorAll('.box').forEach(b => { data.push({ l: b.style.left, t: b.style.top, w: b.style.width, h: b.style.height, c: b.style.backgroundColor }); });
    storage[curP] = data;
  }
  function loadBoxes() {
    overlay.innerHTML = '';
    (storage[curP] || []).forEach(d => {
      const b = document.createElement('div'); b.className = 'box';
      b.style.left = d.l; b.style.top = d.t; b.style.width = d.w; b.style.height = d.h; b.style.background = d.c;
      bindBox(b); overlay.appendChild(b);
    });
  }
  function goToPage(v) { if(!doc || curP+v < 1 || curP+v > doc.numPages) return; saveBoxes(); render(curP+v); }
</script>
</body>
</html>